version: "3"

env:
  MIDDLEWARE_DOCKER_IMAGE: "ghcr.io/lay3rlabs/wavs-middleware:0.4.0-rc"
  ANVIL_PORT: 8548

vars:
  DOCKER_SUDO:
    sh: |
      if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then 
        echo ""
      else 
        echo "sudo"
      fi

tasks:
  deploy:
    desc: "Deploy middleware"
    vars:
      REPO_ROOT: "{{.TASKFILE_DIR}}"
      NODES_DIR: "{{.REPO_ROOT}}/.middleware-nodes"
    env:
      DEPLOY_ENV: "LOCAL"
      LOCAL_ETHEREUM_RPC_URL: "http://localhost:{{.ANVIL_PORT}}"
    cmds:
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        --env-file .env
        -e DEPLOY_ENV
        -e LOCAL_ETHEREUM_RPC_URL
        -v {{.REPO_ROOT}}:/wavs-tools
        -v {{.NODES_DIR}}:/root/.nodes
        {{.MIDDLEWARE_DOCKER_IMAGE}} deploy

  register-operator:
    desc: "Register an operator"
    vars:
      REPO_ROOT: "{{.TASKFILE_DIR}}"
      NODES_DIR: "{{.REPO_ROOT}}/.middleware-nodes"
      WAVS_SERVICE_MANAGER_ADDRESS: '{{.WAVS_SERVICE_MANAGER_ADDRESS | default ""}}'
    env:
      DEPLOY_ENV: "LOCAL"
      LOCAL_ETHEREUM_RPC_URL: "http://localhost:{{.ANVIL_PORT}}"
    cmds:
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        --env-file {{.REPO_ROOT}}/.env
        -e DEPLOY_ENV
        -e LOCAL_ETHEREUM_RPC_URL
        -e WAVS_SERVICE_MANAGER_ADDRESS={{.WAVS_SERVICE_MANAGER_ADDRESS}}
        -v {{.REPO_ROOT}}:/wavs-tools
        -v {{.NODES_DIR}}:/root/.nodes
        {{.MIDDLEWARE_DOCKER_IMAGE}} register {{.CLI_ARGS}}
