version: "3"

env:
  MIDDLEWARE_DOCKER_IMAGE: "ghcr.io/lay3rlabs/wavs-middleware:0.4.0-rc"
  ANVIL_PORT: 8548
  CHAIN_ID: 17000

vars:
  DOCKER_SUDO:
    sh: |
      if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then 
        echo ""
      else 
        echo "sudo"
      fi

tasks:
  deploy:
    desc: "Deploy middleware"
    vars:
      REPO_ROOT: "{{.TASKFILE_DIR}}"
      NODES_DIR: "{{.REPO_ROOT}}/.middleware-nodes"
    env:
      METADATA_URI: "{{.MIDDLEWARE_METADATA_URI}}"
      FUNDED_KEY: "{{.MIDDLEWARE_FUNDED_KEY}}"
      LST_STRATEGY_ADDRESS: "{{.LST_STRATEGY_ADDRESS}}"
      LST_CONTRACT_ADDRESS: "{{.LST_CONTRACT_ADDRESS}}"
      DEPLOY_ENV: "LOCAL"
      LOCAL_ETHEREUM_RPC_URL: "http://localhost:{{.ANVIL_PORT}}"
      ETHERSCAN_API_KEY: "{{.ETHERSCAN_API_KEY}}"
    cmds: 
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -e METADATA_URI
        -e FUNDED_KEY
        -e DEPLOY_ENV 
        -e LOCAL_ETHEREUM_RPC_URL
        -e LST_STRATEGY_ADDRESS
        -e LST_CONTRACT_ADDRESS
        -e ETHERSCAN_API_KEY
        -e CHAIN_ID 
        -v {{.REPO_ROOT}}:/wavs-tools
        -v {{.NODES_DIR}}:/root/.nodes
        {{.MIDDLEWARE_DOCKER_IMAGE}} deploy