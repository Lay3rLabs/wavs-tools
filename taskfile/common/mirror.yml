version: "3"

tasks:
  mirror-deploy:
    desc: "Deploys the mirror contracts for all chains"
    requires:
      vars: [ACTIVE_CHAIN_COUNT, SOURCE_CHAIN_NUMBER]
    cmds:
      - |
        if [ {{.ACTIVE_CHAIN_COUNT}} -lt 2 ]; then
          echo "Error: ACTIVE_CHAIN_COUNT must be 2 or greater"
          exit 1
        fi

        for i in $(seq 1 {{.ACTIVE_CHAIN_COUNT}}); do
          if [ "$i" -ne {{.SOURCE_CHAIN_NUMBER}} ]; then
            task bootstrap:mirror-deploy-$i
          fi
        done

  mirror-deploy-*:
    desc: "Deploys the mirror contracts for a chain"
    vars:
      CHAIN_NUMBER: "{{index .MATCH 0}}"
      SOURCE_RPC_URL:
        sh: cd "{{.REPO_ROOT}}" && task backend:get-evm-rpc-url-{{.SOURCE_CHAIN_NUMBER}}
      MIRROR_RPC_URL:
        sh: cd "{{.REPO_ROOT}}" && task backend:get-evm-rpc-url-{{.CHAIN_NUMBER}}
    requires:
      vars: [REPO_ROOT, PROJECT, SOURCE_CHAIN_NUMBER]
    cmds:
      - >
        cd "{{.REPO_ROOT}}" && task middleware:ecdsa:deploy-mirror
        CHAIN_NUMBER="{{.CHAIN_NUMBER}}"
        PROJECT="{{.PROJECT}}" 
        SERVICE_NAME="{{.PROJECT}}" 
        SOURCE_RPC_URL="{{.SOURCE_RPC_URL}}" 
        MIRROR_RPC_URL="{{.MIRROR_RPC_URL}}"
