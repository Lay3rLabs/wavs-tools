version: "3"

vars:
  REPO_ROOT:
    # find the root directory of the repository by looking for the `.git` directory.
    sh: |
      dir="$(pwd)"
      while [ "$dir" != "/" ]; do
        if [ -d "$dir/.git" ]; then
          echo "$dir"
          exit 0
        fi
        dir="$(dirname "$dir")"
      done
  WAVS_DOCKER_IMAGE: "ghcr.io/lay3rlabs/wavs:35c96a4"
  MIDDLEWARE_DOCKER_IMAGE: "ghcr.io/lay3rlabs/wavs-middleware:0.4.0-rc"
  FOUNDRY_DOCKER_IMAGE: "ghcr.io/foundry-rs/foundry:latest"
  JAEGER_DOCKER_IMAGE: "jaegertracing/jaeger:2.5.0"
  PROMETHEUS_DOCKER_IMAGE: "prom/prometheus:v3.3.0"
  ANVIL_FORK_URL: "https://1rpc.io/holesky"
  WAVS_PORT: 8123
  WAVS_AGGREGATOR_PORT: 8124
  ANVIL_PORT: 8548
  BACKEND_DIR: '{{joinPath .REPO_ROOT "backend"}}'
  WAVS_HOME_DIR: '{{joinPath .BACKEND_DIR "wavs-home"}}'
  WAVS_ENDPOINT: "http://localhost:{{.WAVS_PORT}}"
  WAVS_AGGREGATOR_ENDPOINT: "http://localhost:{{.WAVS_AGGREGATOR_PORT}}"
  EVM_RPC_URL: "http://localhost:{{.ANVIL_PORT}}"
  MIDDLEWARE_NODES_DIR: '{{joinPath .REPO_ROOT ".middleware-nodes"}}'
  MIDDLEWARE_DEPLOY_ENV: "LOCAL"
  ENV_FILE: '{{joinPath .REPO_ROOT ".env"}}'
  COMPONENTS_CARGO_RELEASE_DIR: '{{joinPath .REPO_ROOT "target/wasm32-wasip1/release"}}'
  SERVICE_MANAGER_ADDRESS:
    sh: jq -r '.addresses.WavsServiceManager // empty' "{{.MIDDLEWARE_NODES_DIR}}/avs_deploy.json" 2>/dev/null || true
  STAKE_REGISTRY_ADDRESS:
    sh: jq -r '.addresses.stakeRegistry // empty' "{{.MIDDLEWARE_NODES_DIR}}/avs_deploy.json" 2>/dev/null || true
  DOCKER_SUDO:
    sh: |
      if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then 
        echo ""
      else 
        echo "sudo"
      fi
