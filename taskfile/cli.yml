version: "3"

includes:
  config:
    taskfile: ./config.yml
    flatten: true
  docker:
    taskfile: ./docker.yml
    flatten: true

tasks:
  wavs:
    desc: "Run WAVS CLI commands in Docker container"
    vars:
      WAVS_INSTANCE: "{{.WAVS_INSTANCE | default 1}}"
      WAVS_SUBMISSION_MNEMONIC:
        sh: task backend:get-wavs-submission-mnemonic-{{.WAVS_INSTANCE}}
    cmds:
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -e WAVS_SUBMISSION_MNEMONIC="{{.WAVS_SUBMISSION_MNEMONIC}}"
        -v {{.REPO_ROOT}}:/wavs-tools
        -v {{.WAVS_HOME_DIR}}:/wavs-home 
        {{.WAVS_DOCKER_IMAGE}}
        wavs-cli {{.CLI_ARGS}}

  build-abi-ci:
    desc: "Build ABI files for CI environment (conditional)"
    internal: true
    requires:
      vars: [BUILD_ABI]
    status:
      - '[ "{{.BUILD_ABI}}" != "true" ]'
    cmds:
      - task: build-eigenlayer-abi
      - task: build-wavs-abi
      - task: build-poa-abi

  build-abi:
    desc: "Build all ABI files from smart contracts"
    internal: true
    deps:
      - task: build-eigenlayer-abi
      - task: build-wavs-abi
      - task: build-poa-abi

  build-eigenlayer-abi:
    desc: "Build EigenLayer middleware ABI files"
    internal: true
    dir: "./submodules/eigenlayer-middleware"
    preconditions:
      - sh: "command -v forge"
        msg: "Foundry forge is required but not installed"
    sources: ["contracts/**/*.sol"]
    generates:
      - "{{.ABI_EIGENLAYER_MIDDLEWARE_DIR}}/ECDSAStakeRegistry.sol/**"
      - "{{.ABI_EIGENLAYER_MIDDLEWARE_DIR}}/AllocationManager.sol/**"
    cmds:
      - mkdir -p {{.ABI_EIGENLAYER_MIDDLEWARE_DIR}}
      - forge build
      - for: ["ECDSAStakeRegistry.sol", "AllocationManager.sol"]
        cmd: cp -r "out/{{.ITEM}}" "{{.ABI_EIGENLAYER_MIDDLEWARE_DIR}}/"

  build-wavs-abi:
    desc: "Build WAVS middleware ABI files"
    internal: true
    dir: "./node_modules/@wavs/solidity/contracts"
    preconditions:
      - sh: "command -v forge"
        msg: "Foundry forge is required but not installed"
    sources: ["eigenlayer/ecdsa/**/*.sol"]
    generates:
      - "{{.ABI_WAVS_MIDDLEWARE_DIR}}/IWavsServiceManager.sol/**"
    cmds:
      - mkdir -p {{.ABI_WAVS_MIDDLEWARE_DIR}}
      - forge build -C eigenlayer/ecdsa
      - for: ["IWavsServiceManager.sol"]
        cmd: cp -r "out/{{.ITEM}}" "{{.ABI_WAVS_MIDDLEWARE_DIR}}/"

  build-poa-abi:
    desc: "Build POA middleware ABI files"
    internal: true
    dir: "./submodules/poa-middleware/contracts"
    preconditions:
      - sh: "command -v forge"
        msg: "Foundry forge is required but not installed"
    sources: ["src/**/*.sol"]
    generates:
      - "{{.ABI_POA_MIDDLEWARE_DIR}}/POAStakeRegistry.sol/**"
    cmds:
      - cd ../ && bun install
      - mkdir -p {{.ABI_POA_MIDDLEWARE_DIR}}
      - forge build
      - for: ["POAStakeRegistry.sol"]
        cmd: cp -r "out/{{.ITEM}}" "{{.ABI_POA_MIDDLEWARE_DIR}}/"
