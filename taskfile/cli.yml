version: "3"

includes:
  config:
    taskfile: ./config.yml
    flatten: true

tasks:
  upload-component:
    desc: "Runs WAVS CLI commands"
    cmds:
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -v {{.REPO_ROOT}}:/wavs-tools
        -v {{.WAVS_HOME_DIR}}:/wavs-home 
        {{.WAVS_DOCKER_IMAGE}}
        wavs-cli upload-component {{.CLI_ARGS}} --json true --home /wavs-home --wavs-endpoint {{.WAVS_ENDPOINT}}

  wavs:
    desc: "Runs WAVS CLI commands"
    cmds:
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -v {{.REPO_ROOT}}:/wavs-tools
        -v {{.WAVS_HOME_DIR}}:/wavs-home 
        {{.WAVS_DOCKER_IMAGE}}
        wavs-cli {{.CLI_ARGS}}

  fund-address:
    desc: "Check and fund address with 15 ETH if balance is < 1 ETH"
    vars:
      CURRENT_BALANCE:
        sh: cast balance --ether {{.ADDRESS}} --rpc-url {{.EVM_RPC_URL}}
    cmds:
      - |
        echo "ðŸ”Ž Checking balance for address: {{.ADDRESS}}"
        echo "Current balance: {{.CURRENT_BALANCE}} ETH"

        if (( $(echo "{{.CURRENT_BALANCE}} < 1.0" | bc -l) )); then
          echo "ðŸ’° Funding {{.ADDRESS}} with 15 ETH..."
          cast rpc anvil_setBalance "{{.ADDRESS}}" "15000000000000000000" --rpc-url {{.EVM_RPC_URL}} > /dev/null
          NEW_BALANCE=$(cast balance --ether {{.ADDRESS}} --rpc-url {{.EVM_RPC_URL}})
          echo "âœ… Funded. New balance: ${NEW_BALANCE} ETH"
        else
          echo "âœ… Address already has â‰¥ 1 ETH"
        fi
    requires:
      vars: [ADDRESS, EVM_RPC_URL]

  build-eigenlayer-abi:
    internal: true
    dir: "./submodules/eigenlayer-middleware"
    cmds:
      - mkdir -p {{.ABI_DIR}}
      - forge build
      - for: ["ECDSAStakeRegistry.sol"]
        cmd: cp -r {{.ITEM}} {{.ABI_DIR}}
