version: "3"

includes:
  config:
    taskfile: ./config.yml
    flatten: true
  docker:
    taskfile: ./docker.yml
    flatten: true
  backend: ./backend.yml
  ecdsa:
    taskfile: ./middleware/ecdsa.yml
  mock:
    taskfile: ./middleware/mock.yml
  poa:
    taskfile: ./middleware/poa.yml

tasks:
  get-output-dir:
    desc: "Get the path to the middleware output directory"
    vars:
      CHAIN_NUMBER: "{{.CHAIN_NUMBER | default 1}}"
      CHAIN_DIRNAME: "chain-{{.CHAIN_NUMBER}}"
      OUTPUT_DIR: '{{joinPath .REPO_ROOT "projects" .PROJECT .PROJECT_OUTPUT_DIRNAME .CHAIN_DIRNAME .SERVICE_NAME}}'
    requires:
      vars: [PROJECT, SERVICE_NAME]
    cmds:
      - echo "{{.OUTPUT_DIR}}"

  get-json-filepath:
    desc: "Get the path to the middleware deploy JSON file"
    vars:
      CHAIN_NUMBER: "{{.CHAIN_NUMBER | default 1}}"
      CHAIN_DIRNAME: "chain-{{.CHAIN_NUMBER}}"
      OUTPUT_DIR:
        sh: task middleware:get-output-dir CHAIN_NUMBER={{.CHAIN_NUMBER}} PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}}
    requires:
      vars: [PROJECT, SERVICE_NAME]
    cmds:
      - echo "{{.OUTPUT_DIR}}/avs_deploy.json"

  get-mirror-json-filepath:
    desc: "Get the path to the middleware mirror JSON file"
    vars:
      CHAIN_DIRNAME: "chain-{{.CHAIN_NUMBER}}"
      OUTPUT_DIR:
        sh: task middleware:get-output-dir CHAIN_NUMBER={{.CHAIN_NUMBER}} PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}}
    requires:
      vars: [PROJECT, SERVICE_NAME, CHAIN_NUMBER]
    cmds:
      - echo "{{.OUTPUT_DIR}}/mirror.json"

  get-service-manager-address:
    desc: "Get the WAVS Service Manager address from the middleware deploy JSON file"
    vars:
      CHAIN_NUMBER: "{{.CHAIN_NUMBER | default 1}}"
      JSON_FILEPATH:
        sh: task middleware:get-json-filepath CHAIN_NUMBER={{.CHAIN_NUMBER}} PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}}
    requires:
      vars: [PROJECT, SERVICE_NAME]
    cmds:
      - sh -c 'jq -r ".addresses.WavsServiceManager // empty" "{{.JSON_FILEPATH}}" 2>/dev/null || true'

  get-stake-registry-address:
    desc: "Get the Stake Registry address from the middleware deploy JSON file"
    vars:
      CHAIN_NUMBER: "{{.CHAIN_NUMBER | default 1}}"
      JSON_FILEPATH:
        sh: task middleware:get-json-filepath CHAIN_NUMBER={{.CHAIN_NUMBER}} PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}}
    requires:
      vars: [PROJECT, SERVICE_NAME]
    cmds:
      - sh -c 'jq -r ".addresses.stakeRegistry // empty" "{{.JSON_FILEPATH}}" 2>/dev/null || true'

  get-mirror-stake-registry-address:
    desc: "Get the Mirror Stake Registry address from the middleware JSON file"
    vars:
      JSON_FILEPATH:
        sh: task middleware:get-mirror-json-filepath CHAIN_NUMBER={{.CHAIN_NUMBER}} PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}}
    requires:
      vars: [PROJECT, SERVICE_NAME, CHAIN_NUMBER]
    cmds:
      - sh -c 'jq -r ".addresses.stakeRegistry // empty" "{{.JSON_FILEPATH}}" 2>/dev/null || true'

  get-mirror-service-manager-address:
    desc: "Get the Mirror Service Manager address from the middleware JSON file"
    vars:
      JSON_FILEPATH:
        sh: task middleware:get-mirror-json-filepath CHAIN_NUMBER={{.CHAIN_NUMBER}} PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}}
    requires:
      vars: [PROJECT, SERVICE_NAME, CHAIN_NUMBER]
    cmds:
      - sh -c 'jq -r ".addresses.WavsServiceManager // empty" "{{.JSON_FILEPATH}}" 2>/dev/null || true'

  get-strategy-manager-address:
    desc: "Get the strategy manager address from the deployments JSON file"
    vars:
      CHAIN_ID: "{{.CHAIN_ID | default .MIDDLEWARE_CHAIN_ID}}"
    cmds:
      - sh -c 'jq -r ".addresses.strategyManager" "node_modules/@wavs/solidity/contracts/deployments/eigenlayer-core/{{.CHAIN_ID}}.json" 2>/dev/null || true'
