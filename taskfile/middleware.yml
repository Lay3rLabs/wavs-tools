version: "3"

includes:
  config:
    taskfile: ./config.yml
    flatten: true

tasks:
  deploy:
    desc: "Deploy middleware"
    deps: [clean]
    env:
      DEPLOY_ENV: "{{.MIDDLEWARE_DEPLOY_ENV}}"
      LOCAL_ETHEREUM_RPC_URL: "{{.EVM_RPC_URL}}"
      METADATA_URI: "{{.MIDDLEWARE_METADATA_URI}}"
      LST_CONTRACT_ADDRESS: "{{.MIDDLEWARE_LST_CONTRACT_ADDRESS}}"
      LST_STRATEGY_ADDRESS: "{{.MIDDLEWARE_LST_STRATEGY_ADDRESS}}"
      CHAIN_ID: "{{.MIDDLEWARE_CHAIN_ID}}"
      FUNDED_KEY: 
        sh: "echo $MIDDLEWARE_FUNDED_KEY"
      ETHERSCAN_API_KEY: 
        sh: "echo $MIDDLEWARE_ETHERSCAN_API_KEY"
    cmds:
      - mkdir -p {{.MIDDLEWARE_NODES_DIR}}
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -e FUNDED_KEY 
        -e ETHERSCAN_API_KEY 
        -e DEPLOY_ENV
        -e LOCAL_ETHEREUM_RPC_URL
        -e METADATA_URI 
        -e LST_CONTRACT_ADDRESS 
        -e LST_STRATEGY_ADDRESS
        -e CHAIN_ID 
        -v {{.TASKFILE_DIR}}:/wavs-tools
        -v {{.MIDDLEWARE_NODES_DIR}}:/root/.nodes
        {{.MIDDLEWARE_DOCKER_IMAGE}} deploy

  clean:
    desc: "Clean up middleware nodes directory"
    cmds:
      - rm -rf {{.MIDDLEWARE_NODES_DIR}}

  register-operator:
    desc: "Register an operator"
    env:
      DEPLOY_ENV: "{{.MIDDLEWARE_DEPLOY_ENV}}"
      LOCAL_ETHEREUM_RPC_URL: "{{.EVM_RPC_URL}}"
      LST_CONTRACT_ADDRESS: "{{.MIDDLEWARE_LST_CONTRACT_ADDRESS}}"
      LST_STRATEGY_ADDRESS: "{{.MIDDLEWARE_LST_STRATEGY_ADDRESS}}"
      CHAIN_ID: "{{.MIDDLEWARE_CHAIN_ID}}"
      WAVS_SERVICE_MANAGER_ADDRESS: "{{.MIDDLEWARE_SERVICE_MANAGER_ADDRESS}}"
    cmds:
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -e DEPLOY_ENV
        -e LOCAL_ETHEREUM_RPC_URL
        -e LST_CONTRACT_ADDRESS 
        -e LST_STRATEGY_ADDRESS
        -e CHAIN_ID 
        -e WAVS_SERVICE_MANAGER_ADDRESS
        -v {{.TASKFILE_DIR}}:/wavs-tools
        -v {{.MIDDLEWARE_NODES_DIR}}:/root/.nodes
        {{.MIDDLEWARE_DOCKER_IMAGE}} register {{.CLI_ARGS}}

  list-operators:
    env:
      DEPLOY_ENV: "{{.MIDDLEWARE_DEPLOY_ENV}}"
      LOCAL_ETHEREUM_RPC_URL: "{{.EVM_RPC_URL}}"
      WAVS_SERVICE_MANAGER_ADDRESS: "{{.MIDDLEWARE_SERVICE_MANAGER_ADDRESS}}"
    cmds:
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -e DEPLOY_ENV
        -e LOCAL_ETHEREUM_RPC_URL
        -e WAVS_SERVICE_MANAGER_ADDRESS
        -v {{.TASKFILE_DIR}}:/wavs-tools
        -v {{.MIDDLEWARE_NODES_DIR}}:/root/.nodes
        {{.MIDDLEWARE_DOCKER_IMAGE}} list_operator
