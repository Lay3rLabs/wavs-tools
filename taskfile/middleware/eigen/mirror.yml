version: "3"

includes:
  utils:
    taskfile: ../utils.yml
    flatten: true

tasks:
  deploy-mirror:
    desc: "Deploy mirror contracts for a given service"
    deps:
      - task: clean
        vars:
          PROJECT: "{{.PROJECT}}"
          SERVICE_NAME: "{{.SERVICE_NAME}}"
          CHAIN_NUMBER: "{{.CHAIN_NUMBER}}"
    vars:
      NODES_DIR:
        sh: cd "{{.REPO_ROOT}}" && task middleware:get-output-dir CHAIN_NUMBER={{.CHAIN_NUMBER}} PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}}
    requires:
      vars: [PROJECT, SERVICE_NAME, CHAIN_NUMBER]
    env:
      SOURCE_RPC_URL: "{{.SOURCE_RPC_URL}}"
      MIRROR_RPC_URL: "{{.MIRROR_RPC_URL}}"
      WAVS_SERVICE_MANAGER_ADDRESS:
        sh: cd "{{.REPO_ROOT}}" && task middleware:get-service-manager-address PROJECT="{{.PROJECT}}" SERVICE_NAME="{{.SERVICE_NAME}}"
      FUNDED_KEY: "{{.DEPLOYER_PRIVATE_KEY}}"
    cmds:
      - mkdir -p {{.NODES_DIR}}
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -e DEPLOY_ENV
        -e SOURCE_RPC_URL
        -e MIRROR_RPC_URL
        -e WAVS_SERVICE_MANAGER_ADDRESS
        -e FUNDED_KEY
        -v {{.NODES_DIR}}:/root/.nodes
        {{.MIDDLEWARE_DOCKER_IMAGE}} -m mirror deploy

  list-operators-mirror:
    desc: "List registered operators on a mirror for a given service"
    vars:
      SOURCE_CHAIN_NUMBER: '{{.CHAIN_NUMBER | default "1"}}'
      NODES_DIR:
        sh: cd "{{.REPO_ROOT}}" && task middleware:get-output-dir PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}}
    requires:
      vars: [PROJECT, SERVICE_NAME, MIRROR_CHAIN_NUMBER]
    env:
      SOURCE_RPC_URL:
        sh: cd "{{.REPO_ROOT}}" && task backend:get-evm-rpc-url-{{.SOURCE_CHAIN_NUMBER}}
      MIRROR_RPC_URL:
        sh: cd "{{.REPO_ROOT}}" && task backend:get-evm-rpc-url-{{.MIRROR_CHAIN_NUMBER}}
      SOURCE_SERVICE_MANAGER_ADDRESS:
        sh: cd "{{.REPO_ROOT}}" && task middleware:get-service-manager-address PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}}
      MIRROR_SERVICE_MANAGER_ADDRESS:
        sh: cd "{{.REPO_ROOT}}" && task middleware:get-mirror-service-manager-address PROJECT={{.PROJECT}} SERVICE_NAME={{.SERVICE_NAME}} CHAIN_NUMBER={{.MIRROR_CHAIN_NUMBER}}
    cmds:
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -e DEPLOY_ENV
        -e SOURCE_RPC_URL
        -e MIRROR_RPC_URL
        -e SOURCE_SERVICE_MANAGER_ADDRESS
        -e MIRROR_SERVICE_MANAGER_ADDRESS
        -v {{.NODES_DIR}}:/root/.nodes
        {{.MIDDLEWARE_DOCKER_IMAGE}} -m mirror list_operators
