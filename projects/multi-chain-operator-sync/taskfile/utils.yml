version: "3"

tasks:
  get-submission-address-*:
    desc: "Gets the submission address for a chain"
    vars:
      CHAIN_NUMBER: "{{index .MATCH 0}}"
      OUT_DIR:
        sh: cd "{{.REPO_ROOT}}" && task middleware:get-output-dir CHAIN_NUMBER={{.CHAIN_NUMBER}} PROJECT={{.PROJECT}} SERVICE_NAME={{.PROJECT}}
      MIRROR_PATH: "{{.OUT_DIR}}/mirror.json"
    preconditions:
      - test -f {{.MIRROR_PATH}}
    cmds:
      - |
        jq -r '.addresses.operatorSyncHandler' "{{.MIRROR_PATH}}"

  get-aggregator-simple-flags:
    desc: "Get --values flags with chain_name=address format for active chains (excluding source chain)"
    cmds:
      - |
        CONFIG_FLAGS=""
        for i in $(seq 1 {{.ACTIVE_CHAIN_COUNT}}); do
          if [ "$i" -ne {{.SOURCE_CHAIN_NUMBER}} ]; then
            CHAIN_NAME=$(cd "{{.REPO_ROOT}}" && task backend:get-chain-name-$i)
            SUBMISSION_ADDRESS=$(task get-submission-address-$i)
            CONFIG_FLAGS="$CONFIG_FLAGS --values ${CHAIN_NAME}=${SUBMISSION_ADDRESS}"
          fi
        done
        echo "$CONFIG_FLAGS"
