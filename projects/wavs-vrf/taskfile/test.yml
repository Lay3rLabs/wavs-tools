version: "3"

vars:
  SUBMIT_DELAY: 3

tasks:
  simple:
    cmds:
      - task: trigger-randomness
      - sleep {{.SUBMIT_DELAY}}
      - task: get-randomness-received-event

  trigger-randomness:
    desc: "Request randomness by calling the RandomnessTrigger contract"
    vars:
      TRIGGER_ADDRESS:
        sh: task get-trigger-address
      EVM_RPC_URL:
        sh: task get-evm-rpc-url-1
    cmds:
      # Call requestRandomness() function on the RandomnessTrigger contract
      - >
        cast send "{{.TRIGGER_ADDRESS}}" "requestRandomness()"
        --rpc-url "{{.EVM_RPC_URL}}" 
        --private-key "$DEPLOYER_PRIVATE_KEY"

  get-randomness-received-event:
    desc: "Validates that the randomness received event was emitted"
    vars:
      SUBMISSION_ADDRESS:
        sh: task get-submission-address
      EVM_RPC_URL:
        sh: task get-evm-rpc-url-1
      CURRENT_BLOCK:
        sh: cast block-number --rpc-url {{.EVM_RPC_URL}}
      BLOCK_START:
        sh: echo $(( {{.CURRENT_BLOCK}} - 1 ))
      TOPIC_0:
        sh: cast keccak "RandomnessReceived(bytes32)"
    cmds:
      - >
        cast logs 
        --from-block {{.BLOCK_START}}
        --to-block latest {{.TOPIC_0}}
        --address {{.SUBMISSION_ADDRESS}} 
        --rpc-url {{.EVM_RPC_URL}}
