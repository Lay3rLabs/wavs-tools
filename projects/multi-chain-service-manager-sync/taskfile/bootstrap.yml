version: "3"

includes:
  bootstrap-common:
    taskfile: ../../../taskfile/common/bootstrap.yml
    flatten: true
  mirror-common:
    taskfile: ../../../taskfile/common/mirror.yml
    flatten: true

tasks:
  build-service:
    desc: "Build service configuration"
    vars:
      SERVICE_JSON_CMD: 'service --json true --home /wavs-home --file "{{.WAVS_CLI_SERVICE_JSON_PATH}}"'
      SOURCE_CHAIN:
        sh: cd "{{.REPO_ROOT}}" && task backend:get-chain-name-1
      COMPONENT_DIGEST:
        sh: task get-component-digest
      SERVICE_MANAGER_ADDRESS:
        sh: task get-service-manager-address
      QUORUM_THRESHOLD_UPDATED_EVENT_HASH:
        sh: cast keccak "QuorumThresholdUpdated(uint256,uint256)"
      WORKFLOW_ID:
        sh: cd "{{.REPO_ROOT}}" && task cli:wavs -- {{.SERVICE_JSON_CMD}} workflow add | jq -r .workflow_id
    cmds:
      - |
        cd "{{.REPO_ROOT}}"
        task cli:wavs -- {{.SERVICE_JSON_CMD}} workflow trigger --id {{.WORKFLOW_ID}} set-evm --chain-name {{.SOURCE_CHAIN}} --address {{.SERVICE_MANAGER_ADDRESS}} --event-hash {{.QUORUM_THRESHOLD_UPDATED_EVENT_HASH}}

      - |
        for i in $(seq 2 {{.ACTIVE_CHAIN_COUNT}}); do
          task bootstrap:build-submit-$i SERVICE_JSON_CMD="{{.SERVICE_JSON_CMD}}" WORKFLOW_ID="{{.WORKFLOW_ID}}"
        done

      - |
        cd "{{.REPO_ROOT}}"
        task cli:wavs -- {{.SERVICE_JSON_CMD}} workflow component --id {{.WORKFLOW_ID}} set-source-digest --digest {{.COMPONENT_DIGEST}}
        task cli:wavs -- {{.SERVICE_JSON_CMD}} workflow component --id {{.WORKFLOW_ID}} permissions --http-hosts '*' --file-system true

        echo "Workflow registered"

  build-submit-*:
    desc: "Submit workflow for a specific chain"
    requires:
      vars: [SERVICE_JSON_CMD, WORKFLOW_ID]
    vars:
      CHAIN_NUMBER: "{{index .MATCH 0}}"
      CHAIN_NAME:
        sh: cd "{{.REPO_ROOT}}" && task backend:get-chain-name-{{.CHAIN_NUMBER}}
      SUBMISSION_ADDRESS:
        sh: task get-submission-address-{{.CHAIN_NUMBER}}
    cmds:
      - |
        cd "{{.REPO_ROOT}}"

        if [ "{{.CHAIN_NUMBER}}" -eq 2 ]; then
          task cli:wavs -- {{.SERVICE_JSON_CMD}} workflow submit --id {{.WORKFLOW_ID}} set-aggregator --url {{.WAVS_AGGREGATOR_ENDPOINT}} --address "{{.SUBMISSION_ADDRESS}}" --chain-name "{{.CHAIN_NAME}}"
        else
          task cli:wavs -- {{.SERVICE_JSON_CMD}} workflow submit --id {{.WORKFLOW_ID}} add-aggregator --url {{.WAVS_AGGREGATOR_ENDPOINT}} --address "{{.SUBMISSION_ADDRESS}}" --chain-name "{{.CHAIN_NAME}}"
        fi
