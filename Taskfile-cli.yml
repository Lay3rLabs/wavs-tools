version: "3"

env:
  WAVS_DOCKER_IMAGE: "ghcr.io/lay3rlabs/wavs:0.4.0-rc"
  WAVS_PORT: 8123

vars:
  DOCKER_SUDO:
    sh: |
      if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then 
        echo ""
      else 
        echo "sudo"
      fi

tasks:
  upload-component:
    desc: "Runs WAVS CLI commands"
    vars:
      REPO_ROOT: "{{.TASKFILE_DIR}}"
      WAVS_HOME: "{{joinPath .REPO_ROOT \"backend/wavs-home\"}}"
      WAVS_ENDPOINT: "http://localhost:{{.WAVS_PORT}}"
    cmds: 
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -v {{.REPO_ROOT}}:/wavs-tools
        -v {{.WAVS_HOME}}:/wavs-home 
        {{.WAVS_DOCKER_IMAGE}}
        wavs-cli upload-component {{.CLI_ARGS}} --json true --home /wavs-home --wavs-endpoint {{.WAVS_ENDPOINT}}


  wavs:
    desc: "Runs WAVS CLI commands"
    vars:
      REPO_ROOT: "{{.TASKFILE_DIR}}"
      WAVS_HOME: "{{joinPath .REPO_ROOT \"backend/wavs-home\"}}"
    cmds: 
      - >
        {{.DOCKER_SUDO}} docker run --rm --network host
        -v {{.REPO_ROOT}}:/wavs-tools
        -v {{.WAVS_HOME}}:/wavs-home 
        {{.WAVS_DOCKER_IMAGE}}
        wavs-cli {{.CLI_ARGS}}