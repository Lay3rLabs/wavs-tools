package wavs:aggregator@2.6.0;

use wavs:types/core@2.6.0 as core-types;
use wavs:types/service@2.6.0 as service-types;
use wavs:types/chain@2.6.0 as chain-types;
use wavs:types/events@2.6.0 as event-types;
use wavs:operator/input@2.6.0 as operator-input;
use wavs:operator/output@2.6.0 as operator-output;

interface input {
    use operator-input.{trigger-action};
    use operator-output.{wasm-response};

    record aggregator-input {
        trigger-action: trigger-action,
        operator-response: wasm-response
    }
}

interface output {
    use core-types.{duration, u128};
    use chain-types.{chain-key, evm-address, cosmos-address};

    variant aggregator-action {
        timer(timer-action),
        submit(submit-action),
    }

    record timer-action {
        delay: duration,
    }

    variant submit-action {
        evm(evm-submit-action),
        cosmos(cosmos-submit-action),
    }

    record evm-submit-action {
        chain: chain-key,
        address: evm-address,
        gas-price: option<u128>,
    }

    record cosmos-submit-action {
        chain: chain-key,
        address: cosmos-address,
        gas-price: option<u128>,
    }
}

world aggregator-world {
    // include needed for golang support
    include wasi:cli/imports@0.2.0;

    // wasi:http 0.2.6 uses the `imports` style, but for now import each interface separately
    import wasi:http/types@0.2.0;
    import wasi:http/outgoing-handler@0.2.0;

    // for key-value store support
    include wasi:keyvalue/imports@0.2.0-draft2;

    // for raw socket support
    include wasi:sockets/imports@0.2.0;

    // for tls support
    include wasi:tls/imports@0.2.0-draft;

    import host: interface {
        use chain-types.{evm-chain-config, cosmos-chain-config};
        use core-types.{log-level};
        use service-types.{service-and-workflow-id, workflow-and-workflow-id};
        use event-types.{event-id};

        get-evm-chain-config: func(chain-key: string) -> option<evm-chain-config>;
        get-cosmos-chain-config: func(chain-key: string) -> option<cosmos-chain-config>;

        config-var: func(key: string) -> option<string>;

        log: func(level: log-level, message: string);

        // gets the service and workflow id that called this component
        get-service: func() -> service-and-workflow-id;

        // convenience function to get the workflow without having to walk service.workflows
        get-workflow: func() -> workflow-and-workflow-id;

        // convenience function to get the event-id
        get-event-id: func() -> event-id;
    }

    use input.{aggregator-input};
    use output.{aggregator-action};
    use chain-types.{any-tx-hash};

    export process-input: func(input: aggregator-input) -> result<list<aggregator-action>, string>;

    export handle-timer-callback: func(input: aggregator-input) -> result<list<aggregator-action>, string>;

    export handle-submit-callback: func(input: aggregator-input, tx-result: result<any-tx-hash, string>) -> result<_, string>;
}
